<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Configuración - Votaciones ADUFA</title>
  <meta content="" name="description">
  <meta content="" name="keywords">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Favicons -->
  <link href="../assets/img/logo.png" rel="icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files-->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">
</head>

<body class="index-page">
  <header id="header" class="header fixed-top">
    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center justify-content-between">
        <a href="configuracion.html" class="logo d-flex align-items-center">
          <h1 class="sitename">Votaciones ADUFA</h1>
        </a>
        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="#about" class="nav-link active">Configuración</a></li>
            <li><a href="resultados.html" class="nav-link">Resultados</a></li>
            <li><a href="usuarios.html" class="nav-link">Usuarios ADUFA</a></li>
            <li><a href="auditoria.html" class="nav-link">Auditoría de Usuarios</a></li>
            <li class="dropdown"><a href="#" id="username-display" class="nav-link"> NOMBRE USUARIO <i class="bi bi-chevron-down toggle-dropdown"></i></a>
              <ul>
                <li><a href="#" id="logout-button" class="nav-link">Cerrar Sesión</a></li>
              </ul>
            </li>
          </ul>
          <i class="mobile-nav-toggle d-lg-none bi bi-list"></i>
        </nav>
      </div>
    </div>
  </header>

  <main class="main">
    <section id="about" class="about section">
      <div class="container section-title" data-aos="fade-up">
        <span>Configuración de Votaciones<br></span>
        <h2>Configuración de Votaciones<br></h2>
      </div>

      <div class="container">
        <div class="row px-0" style="margin-top: -50px;">
          <div class="col-lg-2 order-1 order-lg-1 content" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-8 order-2 order-lg-1 content imagenFondoESPE" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-2 order-2 order-lg-1 content" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-2 order-1 order-lg-1 content" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-8 order-2 order-lg-1 content form-container" data-aos="fade-up" data-aos-delay="200">
            <div class="row">
              <div class="col-md-12">
                <form id="initialForm">
                  <p style="text-align: center; font-size: 12px;">En este espacio especificará el periodo de elecciones al cual desea implementar la votación electrónica, además se seleccionarán el número de candidatos por cada una de las necesidades que requiera. En caso de no requerir de alguna dignidad ponga una cantidad 0.</p>
                  <div class="form-group row my-2">
                    <label for="periodo" class="col-sm-4 col-form-label">Periodo de Elecciones</label>
                    <div class="col-sm-8">
                      <input type="text" class="form-control" id="periodo" placeholder="Ingrese el periodo de elecciones" required="1">
                    </div>
                  </div>
                  <hr>
                  <div style="background-color: white; width: 105%; margin-left: -20px;">
                    <div style="background-color: rgba(0, 0, 0, 0.1); width: 100%; height: 15px;"></div>
                  </div>
                  <div class="form-group row my-2">
                    <label for="listas" class="col-sm-4 col-form-label" style="color: var(--accent-color);font-size: 20px;">Listas</label>
                    <hr>
                    <label for="listas" class="col-sm-4 col-form-label">Ingrese Número de Listas</label>
                    <div class="col-sm-8">
                      <input type="number" class="form-control" id="numListas" min="0" placeholder="Cantidad" required="1">
                    </div>
                  </div>
                  <br>
                  <div class="form-group row my-2">
                    <label for="fechaPublicacion" class="col-sm-4 col-form-label">Fecha de Publicación</label>
                    <div class="col-sm-8">
                      <input type="date" class="form-control" id="fechaPublicacion" name="fechaPublicacion" min="" max="" required>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="horaInicio">Hora de Inicio</label>
                    <input type="time" id="horaInicio" class="form-control" required>
                  </div>
                  <div class="form-group">
                    <label for="horaFin">Hora de Fin</label>
                    <input type="time" id="horaFin" class="form-control" required>
                  </div>
                  <div class="form-group row my-2">
                    <div class="col-sm-12 text-center">
                      <button type="submit" class="read-more">Enviar</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <div id="secondFormContainer" style="display: none;"></div>

            <div id="thirdFormContainer" style="display: none;">
              <h2 class="text-center mb-4">Formulario de Votación</h2>
              <form id="votingForm">
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer id="footer" class="footer position-relative"><br>
    <div class="container copyright text-center mt-4">
      <p><strong class="px-1 sitename">Universidad de las Fuerzas Armadas "ESPE"</strong></p>
      <div class="credits">
        <strong class="px-1 sitename">Asociación de Docentes de las Fuerzas Armadas</strong> <span> 2024</span>
      </div>
    </div>
  </footer>

  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <div id="preloader"></div>

  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="../assets/js/main.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const usuario = localStorage.getItem('usuario');
      const rol = localStorage.getItem('rol');

      // Verificar si el usuario tiene permiso (rol 1)
      if (!rol || rol !== '1') {
        window.location.href = '/';
        return;
      }

      // Actualizar el nombre de usuario en el display
      if (usuario) {
        document.getElementById('username-display').innerHTML = `${usuario} <i class="bi bi-chevron-down toggle-dropdown"></i>`;
      }

      // Configurar las fechas mínima y máxima permitidas
      const fechaPublicacion = document.getElementById('fechaPublicacion');
      const hoy = new Date();
      const maxDate = new Date();
      maxDate.setFullYear(hoy.getFullYear() + 10); // Máximo 10 años en el futuro
      
      // Formatear las fechas para el input date
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      // Establecer fecha mínima como hoy
      const fechaMinima = formatDate(hoy);
      fechaPublicacion.setAttribute('min', fechaMinima);
      fechaPublicacion.setAttribute('max', formatDate(maxDate));

      // Manejar el cierre de sesión
      document.getElementById('logout-button').addEventListener('click', function() {
        localStorage.removeItem('rol');
        localStorage.removeItem('usuario');
        window.location.href = '/';
      });
    });

    document.getElementById('initialForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const periodo = document.getElementById('periodo').value;
      const numListas = parseInt(document.getElementById('numListas').value);
      const fechaPublicacion = document.getElementById('fechaPublicacion').value;

      // fetch('/guardar-configuracion', {
      //     method: 'POST',
      //     headers: {
      //       'Content-Type': 'application/json'
      //     },
      //     body: JSON.stringify({ periodo, numListas, fechaPublicacion })
      //   })
      //   .then(response => response.json())
      //   .then(data => {
      //     if (data.success) {
      //       alert('Configuración guardada correctamente.');
      //     } else {
      //       alert('Error al guardar la configuración.');
      //     }
      //   }) 
      // .catch(error => console.error('Error:', error)); 

      let secondFormHtml = `
          <p style="text-align: center; font-size: 12px;">En este apartado se ingresarán cada uno de los candidatos postulados, separados por dignidades para su correcta selección.</p>
          <h4>Periodo ${periodo}</h4>
          <form id="secondForm" action="/uploadProvisionales" method="POST" enctype="multipart/form-data">
            <br><div style="background-color: white; width: 105%; margin-left: -20px;">
                <div style="background-color: rgba(0, 0, 0, 0.1); width: 100%; height: 15px;"></div>
              </div>`;

      for (let lista = 1; lista <= numListas; lista++) {
          secondFormHtml += `
              <h4 style="color: var(--accent-color); padding-top: 15px;">Lista ${lista}</h4><hr>
              <div class="form-group row my-2">
                <label class="col-sm-4 col-form-label">Nombre de la lista</label>
                <div class="col-sm-8">
                  <input type="text" id="nombreLista${lista}" name="nombreLista${lista}" class="form-control" placeholder="Ingrese el nombre de la lista" required>
                </div>
              </div>
              <div class="form-group row my-2">
                <label class="col-sm-4 col-form-label">Foto del Presidente</label>
                <div class="col-sm-8">
                  <input type="file" id="fotoPresidenteLista${lista}periodo${periodo}" name="fotoPresidenteLista${lista}periodo${periodo}" class="form-control-file" accept="image/*" required>
                </div>
              </div>
              <div class="form-group row my-2">
                <label class="col-sm-4 col-form-label">Foto del Vicepresidente</label>
                <div class="col-sm-8">
                  <input type="file" id="fotoVicepresidenteLista${lista}periodo${periodo}" name="fotoVicepresidenteLista${lista}periodo${periodo}" class="form-control-file" accept="image/*" required>
                </div>
              </div>`;
          
          const dignidades = ['Presidente', 'Vicepresidente', 'Secretario', 'Tesorero', 'Sindico'];
          dignidades.forEach(dignidad => {
              secondFormHtml += `
              <div class="form-group row my-2">
                <label class="col-sm-4 col-form-label">${dignidad}</label>
                <div class="col-sm-8">
                  <select id="${dignidad.toLowerCase()}Lista${lista}" name="${dignidad.toLowerCase()}${lista}" class="form-control user-select" required>
                    <option value="" disabled selected>Seleccione un ${dignidad.toLowerCase()}</option>
                  </select>
                </div>
              </div>`;
          });

          for (let i = 1; i <= 3; i++) {
              secondFormHtml += `
              <div class="form-group row my-2">
                <label class="col-sm-4 col-form-label">Vocal Principal ${i}</label>
                <div class="col-sm-8">
                  <select id="vocalPrincipal${i}Lista${lista}" name="vocalPrincipal${i}Lista${lista}" class="form-control user-select" required>
                    <option value="" disabled selected>Seleccione un vocal principal</option>
                  </select>
                </div>
              </div>`;
          }

          for (let i = 1; i <= 3; i++) {
              secondFormHtml += `
              <div class="form-group row my-2">
                <label class="col-sm-4 col-form-label">Vocal Suplente ${i}</label>
                <div class="col-sm-8">
                  <select id="vocalSuplente${i}Lista${lista}" name="vocalSuplente${i}Lista${lista}" class="form-control user-select" required>
                    <option value="" disabled selected>Seleccione un vocal suplente</option>
                  </select>
                </div>
              </div>`;
          }

          secondFormHtml += `<br><div style="background-color: white; width: 105%; margin-left: -20px;">
              <div style="background-color: rgba(0, 0, 0, 0.1); width: 100%; height: 15px;"></div>
              </div>`;
      }

      secondFormHtml += `<br>
          <div class="form-group row my-2">
            <div class="col-sm-12 text-center">
              <button type="submit" class="read-more" id="submitButton">Enviar</button>
              <button type="button" class="read-more" id="backButton">Regresar</button>
            </div>
          </div>
        </form>`;

      document.getElementById('secondFormContainer').innerHTML = secondFormHtml;

      document.getElementById('initialForm').style.display = 'none';
      document.getElementById('secondFormContainer').style.display = 'block';

      document.getElementById('backButton').addEventListener('click', function() {
        document.getElementById('secondFormContainer').style.display = 'none';
        document.getElementById('initialForm').style.display = 'block';
      });
  
      // document.getElementById('secondForm').addEventListener('submit', function(event) {
      //   event.preventDefault();
  
      //   const formData = new FormData(this);
      //   formData.append('periodo', periodo);
  
      //   const formDataObj = {};
      //   formData.forEach((value, key) => {
      //     formDataObj[key] = value;
      //   });
  
      //   localStorage.setItem('formData', JSON.stringify(formDataObj));
  
      //   window.location.href = 'votacion.html';
      // });
      // Verificar si el botón de enviar y el formulario están correctamente configurados
      document.getElementById('secondForm').addEventListener('submit', function(event) {
        event.preventDefault();

        // Deshabilitar el botón de envío para evitar múltiples envíos
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';

        const form = document.getElementById('secondForm');
        const formData = new FormData(form);

        // Primero subir las imágenes
        fetch('/uploadProvisionales', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Si las imágenes se subieron correctamente, guardar el resto de los datos en localStorage
            const listas = [];

            for (let lista = 1; lista <= numListas; lista++) {
              const presidenteSelect = document.getElementById(`presidenteLista${lista}`);
              const vicepresidenteSelect = document.getElementById(`vicepresidenteLista${lista}`);
              const secretarioSelect = document.getElementById(`secretarioLista${lista}`);
              const tesoreroSelect = document.getElementById(`tesoreroLista${lista}`);
              const sindicoSelect = document.getElementById(`sindicoLista${lista}`);

              const vocalesPrincipales = [];
              const vocalesSuplentes = [];

              for (let i = 1; i <= 3; i++) {
                const vocalPrincipalSelect = document.getElementById(`vocalPrincipal${i}Lista${lista}`);
                const vocalSuplenteSelect = document.getElementById(`vocalSuplente${i}Lista${lista}`);

                if (vocalPrincipalSelect && vocalPrincipalSelect.value) {
                  vocalesPrincipales.push(vocalPrincipalSelect.value);
                }
                if (vocalSuplenteSelect && vocalSuplenteSelect.value) {
                  vocalesSuplentes.push(vocalSuplenteSelect.value);
                }
              }

              const listaData = {
                nombreLista: document.getElementById(`nombreLista${lista}`).value,
                presidente: presidenteSelect ? presidenteSelect.value : null,
                vicepresidente: vicepresidenteSelect ? vicepresidenteSelect.value : null,
                secretario: secretarioSelect ? secretarioSelect.value : null,
                tesorero: tesoreroSelect ? tesoreroSelect.value : null,
                sindico: sindicoSelect ? sindicoSelect.value : null,
                vocalesPrincipales,
                vocalesSuplentes
              };

              listas.push(listaData);
            }

            const formDataCompleto = {
              periodo: periodo,
              fechaPublicacion: document.getElementById('fechaPublicacion').value,
              horaInicio: document.getElementById('horaInicio').value,
              horaFin: document.getElementById('horaFin').value,
              listas: listas
            };

            // Guardar en localStorage
            localStorage.setItem('formDataCompleto', JSON.stringify(formDataCompleto));

            // Redirigir a la página de previsualización
            window.location.href = 'votacion.html';
          } else {
            alert('Error al guardar las imágenes: ' + data.message);
            // Reactivar el botón en caso de error
            submitButton.disabled = false;
            submitButton.textContent = 'Enviar';
          }
        })
        .catch(error => {
          console.error('Error al guardar las imágenes:', error);
          alert('Error al subir las imágenes');
          // Reactivar el botón en caso de error
          submitButton.disabled = false;
          submitButton.textContent = 'Enviar';
        });
    });

      function saveImages(periodo) {
        // const form = document.getElementById('secondForm');
        // const formFotos = new FormData(form);

        const form = document.getElementById('secondForm');
        const formFotos = new FormData();

        // Obtener todos los campos de tipo "file" del formulario
        const fileInputs = form.querySelectorAll('input[type="file"]');

        // Agregar solo los archivos de imagen a formFotos
        fileInputs.forEach(input => {
            if (input.files.length > 0) {
                formFotos.append(input.name, input.files[0]);
            }
        });

        // Imprimir el contenido de formFotos en la consola
        for (const pair of formFotos.entries()) {
            console.log(`${pair[0]}: ${pair[1].name}`);
        }

        fetch('/upload', {
          method: 'POST',
          body: formFotos
        })
        .then(response => response.json())
        .then(data => {
          alert('Imágenes guardadas exitosamente.');
        })
        .catch(error => {
          // console.error('Error al guardar las imágenes:', error);  // Imprime el error en la consola
          // alert('Error al guardar las imágenes. Ver consola para detalles.');
        });
      }

      // Obtener usuarios y llenar los campos de selección nuevamente
      let todosLosUsuarios = []; // Variable para almacenar todos los usuarios
      let usuariosDisponibles = []; // Variable para almacenar usuarios disponibles

      fetch('/api/usuarios')
        .then(response => response.json())
        .then(data => {
          console.log('Datos de usuarios recibidos:', data);
          todosLosUsuarios = data;
          usuariosDisponibles = [...data]; // Copia inicial de todos los usuarios
          
          // Función para actualizar los selectores con usuarios disponibles
          function actualizarSelectores(selectorActual = null) {
            const userSelects = document.querySelectorAll('.user-select');
            
            userSelects.forEach(select => {
              // Guardar el valor seleccionado actual
              const valorActual = select.value;
              
              // Limpiar opciones existentes, manteniendo solo la opción por defecto
              while (select.options.length > 1) {
                select.remove(1);
              }
              
              // Agregar usuarios disponibles
              usuariosDisponibles.forEach(user => {
                // Si es el selector actual o el usuario está disponible
                if (select === selectorActual || !estaSeleccionado(user.id)) {
                  const option = document.createElement('option');
                  option.value = `${user.id}`;
                  option.text = `${user.nombres} ${user.apellidos}`;
                  select.appendChild(option);
                }
              });
              
              // Restaurar el valor seleccionado si aún está disponible
              if (valorActual && (select === selectorActual || !estaSeleccionado(valorActual))) {
                select.value = valorActual;
              }
            });
          }
          
          // Función para verificar si un usuario ya está seleccionado
          function estaSeleccionado(userId) {
            const userSelects = document.querySelectorAll('.user-select');
            for (const select of userSelects) {
              if (select.value === userId) {
                return true;
              }
            }
            return false;
          }
          
          // Agregar event listeners a todos los selectores
          document.addEventListener('change', function(event) {
            if (event.target.classList.contains('user-select')) {
              actualizarSelectores(event.target);
            }
          });
          
          // Inicializar los selectores
          actualizarSelectores();
        })
        .catch(err => console.error('Error al obtener los usuarios:', err));
    });
  </script>
</body>
</html>