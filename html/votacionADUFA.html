<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Configuración del documento -->
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Votaciones ADUFA</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="../assets/img/logo.png" rel="icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="stylesheet">
  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">
</head>

<body class="index-page">

  <header id="header" class="header fixed-top">
    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center justify-content-between">
        <a href="../index.html" class="logo d-flex align-items-center">
          <h1 class="sitename">Votaciones ADUFA</h1>
        </a>
        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="#about">Configuración</a></li>
            <li class="dropdown"><a href="#" id="username-display"> NOMBRE USUARIO <i class="bi bi-chevron-down toggle-dropdown"></i></a>
              <ul>
                <li><a href="#" id="logout-button">Cerrar Sesión</a></li>
              </ul>
            </li>
          </ul>
          <i class="mobile-nav-toggle d-lg-none bi bi-list"></i>
        </nav>
      </div>
    </div>
  </header>

  <main class="main">
    <section id="about" class="about section">
      <div class="container section-title" data-aos="fade-up">
        <span>Votaciones Directiva ADUFA<br></span>
        <h2>Votaciones Directiva ADUFA<br></h2>
      </div>

      <div class="container">
        <div class="row px-0" style="margin-top: -50px;">
          <div class="col-lg-12 order-2 order-lg-1 content imagenFondoESPEVotacion" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-12 order-2 order-lg-1 content form-container" data-aos="fade-up" data-aos-delay="200">
            <h7 id="MensajePrevio" style="text-align: center;">En este proceso electoral usted votará por los candidatos postulados para la directiva de la asociación de docentes de las Fuerzas Armadas "ADUFA" en el periodo actual.</h7>
            <br>
            <div class="row">
              <div class="col-md-12">
                <form id="votacionForm">
                  <div id="checkboxesContainer"></div>
                  <br>
                  <div class="col-sm-12 text-center">
                    <button type="button" class="read-more" id="submitVoteButton">Enviar Voto</button>
                    <button type="button" class="read-more" id="backButton">Regresar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- Modal de Términos y Condiciones -->
  <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="termsModalLabel">Términos y Condiciones</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>De acuerdo con la legislación vigente en Ecuador sobre la protección de datos personales, su participación en el proceso de votación implica el tratamiento de ciertos datos personales. Al aceptar estos términos, usted consiente expresamente que se registre el hecho de que ha ejercido su derecho al voto, aunque no se registrará por quién ha votado. Esta información podrá ser utilizada exclusivamente para garantizar la integridad del proceso electoral y, si usted da su consentimiento, podrá ser visible en la sección de auditoría.</p>
          
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="acceptAudit">
            <label class="form-check-label" for="acceptAudit">
              Autorizo que mi participación en la votación sea visible en la auditoría (opcional).
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirmVote">Confirmar Voto</button>
        </div>
      </div>
    </div>
  </div>

  <footer id="footer" class="footer position-relative"><br>
    <div class="container copyright text-center mt-4">
      <p><strong class="px-1 sitename">Universidad de las Fuerzas Armadas "ESPE"</strong></p>
      <div class="credits">
        <strong class="px-1 sitename">Asociación de Docentes de las Fuerzas Armadas</strong> <span> 2024</span>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>

  <!-- Main JS File -->
  <script src="../assets/js/main.js"></script>

  <script>
    // Temporizador de sesión - 3 minutos
    let tiempoSesion;
    
    function iniciarTemporizador() {
      // Limpiar temporizador existente si hay uno
      if (tiempoSesion) {
        clearTimeout(tiempoSesion);
      }
      
      // Establecer nuevo temporizador (3 minutos = 180000 ms)
      tiempoSesion = setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const periodo = urlParams.get('periodo');
        
        // Primero mostrar el mensaje
        alert('Su sesión ha expirado por inactividad. Por favor, inicie sesión nuevamente.');
        
        // Luego eliminar los datos de sesión
        localStorage.removeItem('rol');
        localStorage.removeItem('usuario');
        
        // Finalmente redirigir
        window.location.replace(`/?periodo=${periodo}`);
      }, 180000);
    }

    // Reiniciar el temporizador cuando hay actividad
    function reiniciarTemporizador() {
      const rol = localStorage.getItem('rol');
      if (rol === '2') { // Solo para usuarios con rol 2
        iniciarTemporizador();
      }
    }

    // Eventos para detectar actividad del usuario
    document.addEventListener('mousemove', reiniciarTemporizador);
    document.addEventListener('keypress', reiniciarTemporizador);
    document.addEventListener('click', reiniciarTemporizador);
    document.addEventListener('scroll', reiniciarTemporizador);

    // Iniciar el temporizador cuando se carga la página
    document.addEventListener('DOMContentLoaded', () => {
      const rol = localStorage.getItem('rol');
      const usuario = localStorage.getItem('usuario');
      const urlParams = new URLSearchParams(window.location.search);
      const periodo = urlParams.get('periodo');

      // Verificar si hay usuario y actualizar el display
      if (usuario) {
        document.getElementById('username-display').innerHTML = `${usuario} <i class="bi bi-chevron-down toggle-dropdown"></i>`;
      } else {
        window.location.href = `/?periodo=${periodo}`;
      }

      // Manejar el cierre de sesión
      document.getElementById('logout-button').addEventListener('click', function() {
        localStorage.removeItem('rol');
        localStorage.removeItem('usuario');
        window.location.href = `/?periodo=${periodo}`;
      });

      // Iniciar temporizador si es rol 2
      if (rol === '2') {
        iniciarTemporizador();
      }

      // Función para decodificar caracteres especiales
      function decodificarTexto(texto) {
        const textArea = document.createElement('textarea');
        textArea.innerHTML = texto;
        return textArea.value;
      }

      // Función para obtener y mostrar los candidatos
      async function getCandidates(periodo) {
        try {
          const response = await fetch(`/obtener-candidatos?periodo=${periodo}`);
          const data = await response.json();
          const listas = {};

          data.forEach(candidate => {
              if (!listas[candidate.idLista]) {
                  listas[candidate.idLista] = {
                      nombreLista: candidate.nombreLista,
                      presidente: '',
                      vicepresidente: '',
                      secretario: '',
                      tesorero: '',
                      sindico: '',
                      vocalesPrincipales: ['', '', ''],
                      vocalesSuplentes: ['', '', '']
                  };
              }

              switch (candidate.dignidadCand) {
                  case 'presidente':
                      listas[candidate.idLista].presidente = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vicepresidente':
                      listas[candidate.idLista].vicepresidente = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'secretario':
                      listas[candidate.idLista].secretario = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'tesorero':
                      listas[candidate.idLista].tesorero = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'sindico':
                      listas[candidate.idLista].sindico = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vocalPrincipal1':
                      listas[candidate.idLista].vocalesPrincipales[0] = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vocalPrincipal2':
                      listas[candidate.idLista].vocalesPrincipales[1] = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vocalPrincipal3':
                      listas[candidate.idLista].vocalesPrincipales[2] = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vocalSuplente1':
                      listas[candidate.idLista].vocalesSuplentes[0] = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vocalSuplente2':
                      listas[candidate.idLista].vocalesSuplentes[1] = decodificarTexto(candidate.nombreCompleto);
                      break;
                  case 'vocalSuplente3':
                      listas[candidate.idLista].vocalesSuplentes[2] = decodificarTexto(candidate.nombreCompleto);
                      break;
              }
          });

          // Renderizar los datos obtenidos en el formulario
          const checkboxesContainer = document.getElementById('checkboxesContainer');
          checkboxesContainer.innerHTML += `<br><h3 style:"font-weight: bold;">Periodo ${periodo}</h3>
          <form id="secondForm">
            <br>
            <hr>
            <br>
            <div class="radio-tile-group">
              <div class="form-check-inline col-md-1"></div>
              <div class="form-check-inline col-md-10">
                <input class="radio-button-nulo" type="radio" id="nulo" name="lista" value="nulo">
                <label class="btn-nulo" for="nulo"> VOTAR NULO</label>
              </div>
              <div class="form-check-inline col-md-1"></div>`;

          Object.keys(listas).forEach((listaId, index) => {
            const lista = listas[listaId];
            let listaHtml = `
              <div class="input-container form-check-inline">
                <input class="radio-button" type="radio" id="lista${index + 1}" name="lista" value="LISTA${index + 1}">&nbsp&nbsp
                <div class="radio-tile">
                  <h4 style="color: var(--accent-color); padding-top: 15px; font-weight: bold;">Lista ${index + 1} - ${lista.nombreLista}</h4>
                  <hr>
                  <label for="lista${index + 1}">
                    <div class="row justify-content-center">
                      <div class="col-12 col-sm-6 col-md-6 mb-3" style="text-align: center;">
                        <img src="../assets/img/fotosListas/fotoPresidenteLista${index + 1}periodo${periodo}.png" 
                             alt="Presidente ${index + 1}" 
                             class="img-fluid" 
                             style="max-width: 120px; height: auto; display: block; margin: 0 auto;">
                        <span class="lista-item">Presidente</span>
                      </div>
                      <div class="col-12 col-sm-6 col-md-6 mb-3" style="text-align: center;">
                        <img src="../assets/img/fotosListas/fotoVicepresidenteLista${index + 1}periodo${periodo}.png" 
                             alt="Vicepresidente ${index + 1}" 
                             class="img-fluid" 
                             style="max-width: 120px; height: auto; display: block; margin: 0 auto;">
                        <span class="lista-item" style="text-align: center;">Vicepresidente</span>
                      </div>
                    </div>
                    <div class="row mt-3">
                      <div class="col-12 col-md-4 mb-2">
                        <span class="lista-item">Presidente:</span> ${lista.presidente}
                      </div>
                      <div class="col-12 col-md-4 mb-2">
                        <span class="lista-item">Vicepresidente:</span> ${lista.vicepresidente}
                      </div>
                      <div class="col-12 col-md-4 mb-2">
                        <span class="lista-item">Secretario:</span> ${lista.secretario}
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-12 col-md-6 mb-2">
                        <span class="lista-item">Tesorero:</span> ${lista.tesorero}
                      </div>
                      <div class="col-12 col-md-6 mb-2">
                        <span class="lista-item">Síndico:</span> ${lista.sindico}
                      </div>
                    </div>
                    <div class="row mt-3">
                      <div class="col-12 col-md-6 mb-3">
                        <h5 class="mb-2">Vocales Principales:</h5>
                        <div class="mb-1"><span class="lista-item">Vocal Principal 1:</span> ${lista.vocalesPrincipales[0]}</div>
                        <div class="mb-1"><span class="lista-item">Vocal Principal 2:</span> ${lista.vocalesPrincipales[1]}</div>
                        <div class="mb-1"><span class="lista-item">Vocal Principal 3:</span> ${lista.vocalesPrincipales[2]}</div>
                      </div>
                      <div class="col-12 col-md-6 mb-3">
                        <h5 class="mb-2">Vocales Suplentes:</h5>
                        <div class="mb-1"><span class="lista-item">Vocal Suplente 1:</span> ${lista.vocalesSuplentes[0]}</div>
                        <div class="mb-1"><span class="lista-item">Vocal Suplente 2:</span> ${lista.vocalesSuplentes[1]}</div>
                        <div class="mb-1"><span class="lista-item">Vocal Suplente 3:</span> ${lista.vocalesSuplentes[2]}</div>
                      </div>
                    </div>
                  </label>
                </div>
                <br>
              </div>
            `;
            checkboxesContainer.innerHTML += listaHtml;
          });

          // Agregar campo "NULO" al final
          checkboxesContainer.innerHTML += `<br>
              </div></form>
            `;

        } catch (error) {
          console.error('Error:', error);
        }
      }

      // Llamar a la función para obtener y mostrar candidatos al cargar la página
      getCandidates(periodo);

      // Evento para regresar al formulario anterior
      const backButton = document.getElementById('backButton');
      backButton.addEventListener('click', () => {
        window.history.back();
      });

      // Llamar a la API para verificar si el usuario ha votado
      async function verificarVoto(usuario, periodo) {
        try {
          // Primero verificar si está dentro del horario permitido
          const horarioResponse = await fetch(`/verificar-horario?periodo=${periodo}`);
          const horarioData = await horarioResponse.json();

          if (!horarioData.puedeVotar) {
            document.getElementById('votacionForm').style.display = 'none';
            document.getElementById('MensajePrevio').style.display = 'none';
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('alert', 'alert-warning', 'mt-3');
            messageContainer.innerHTML = `<strong>Aviso:</strong><br>${horarioData.mensaje}`;
            document.querySelector('.form-container').appendChild(messageContainer);
            return;
          }

          // Si está en horario, verificar si ya votó
          const response = await fetch(`/verificar-voto?usuario=${usuario}&periodo=${periodo}`);
          const data = await response.json();

          if (data.votoRealizado) {
            document.getElementById('votacionForm').style.display = 'none';
            document.getElementById('MensajePrevio').style.display = 'none';
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('alert', 'alert-info', 'mt-3');
            messageContainer.innerHTML = `<strong>Período:</strong> ${periodo}<br>Usted ya ha ejercido su voto para estas elecciones.`;
            document.querySelector('.form-container').appendChild(messageContainer);
          }
        } catch (error) {
          console.error('Error al verificar voto:', error);
        }
      }

      if (usuario && periodo) {
        verificarVoto(usuario, periodo);
      }

      // Mostrar modal de términos y condiciones antes de enviar el voto
      document.getElementById('submitVoteButton').addEventListener('click', function() {
        const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
        termsModal.show();
      });

      // Evento para confirmar el voto después de aceptar los términos
      document.getElementById('confirmVote').addEventListener('click', async function() {
        const acceptAudit = document.getElementById('acceptAudit').checked;


        try {
          const usuario = localStorage.getItem('usuario');
          const listaseleccionada = document.querySelector('input[name="lista"]:checked').value;

          const formData = {
            periodo: periodo,
            idLista: listaseleccionada,
            aceptaAuditoria: acceptAudit // Enviar si el usuario acepta estar en la auditoría
          };

          const response = await fetch('/guardar-votos', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ usuario, formData })
          });

          const result = await response.json();
          alert(result.message);

          // Ocultar el modal y recargar la página
          const termsModal = bootstrap.Modal.getInstance(document.getElementById('termsModal'));
          termsModal.hide();
          window.location.reload();
        } catch (error) {
          console.error('Error:', error);
          alert('Error al guardar los votos');
        }
      });

      function handleImageError(img) {
        img.onerror = null; // Prevenir bucle infinito
        img.src = '../assets/img/fotosListas/defaultCandidato.png';
      }
    });
  </script>

</body>

</html>
