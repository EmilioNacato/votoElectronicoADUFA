<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados - Votaciones ADUFA</title>
  <meta content="" name="description">
  <meta content="" name="keywords">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- Favicons -->
  <link href="../assets/img/logo.png" rel="icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files-->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header id="header" class="header fixed-top">
    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center justify-content-between">
        <a href="configuracion.html" class="logo d-flex align-items-center">
          <h1 class="sitename">Votaciones ADUFA</h1>
        </a>
        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="configuracion.html" class="nav-link">Configuración</a></li>
            <li><a href="#about" class="nav-link active">Resultados</a></li>
            <li><a href="usuarios.html" class="nav-link">Usuarios ADUFA</a></li>
            <li><a href="auditoria.html" class="nav-link">Auditoría de Usuarios</a></li>
            <li class="dropdown"><a href="#" id="username-display" class="nav-link"> NOMBRE USUARIO <i class="bi bi-chevron-down toggle-dropdown"></i></a>
              <ul>
                <li><a href="#" id="logout-button" class="nav-link">Cerrar Sesión</a></li>
              </ul>
            </li>
          </ul>
          <i class="mobile-nav-toggle d-lg-none bi bi-list"></i>
        </nav>
      </div>
    </div>
  </header>

  <main class="main">
    <section id="about" class="about section">
      <div class="container section-title" data-aos="fade-up">
        <span>Resultado de Votaciones<br></span>
        <h2>Resultado de Votaciones<br></h2>
      </div>

      <div class="container">
        <div class="row px-0" style="margin-top: -50px;">
          <div class="col-lg-2 order-1 order-lg-1 content" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-8 order-2 order-lg-1 content imagenFondoESPE" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-2 order-2 order-lg-1 content" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-2 order-1 order-lg-1 content" data-aos="fade-up" data-aos-delay="200"></div>
          <div class="col-lg-8 order-2 order-lg-1 content form-container" data-aos="fade-up" data-aos-delay="200">
            <div class="row">
              <div class="col-md-12">
                <form id="initialForm">
                  <p style="text-align: center; font-size: 12px;">En este apartado, podrá visualizar los resultados detallados de las votaciones correspondientes al periodo seleccionado. Los resultados se presentan por dignidades, mostrando el número de votos obtenidos por cada candidato, así como los votos nulos. Además, se destacará el candidato ganador de cada categoría.</p>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    <section class="section">
      <div class="container" data-aos="fade-up" data-aos-delay="200">
        <div class="container">
          <form id="resultForm">
            <div class="form-group">
              <label for="periodoSelect">Periodo de Elecciones</label><br><br>
              <select id="periodoSelect" class="form-control" required>
                <option value="" disabled selected>Seleccione un periodo</option>
              </select>
            </div>
            <div class="form-group"><br>
              <label for="filterTypeSelect">Filtrar por</label><br><br>
              <select id="filterTypeSelect" class="form-control" required>
                <option value="lista" selected>Lista</option>
                <option value="departamento">Departamento</option>
              </select>
            </div><br>
            <button type="submit" class="btn btn-danger">Consultar</button>
          </form>

          <div id="resultContainer" style="display: none; margin-top: 20px;">
            <h4 id="periodoHeader" class="text-center my-4"></h4>
            <div id="resultTable"></div>
            
            <!-- Contenedor para mostrar los ganadores -->
            <div id="ganadoresContainer" class="mt-4" style="display: none;">
              <h3 class="text-center mb-4" style="color: var(--accent-color);">Lista Ganadora</h3>
              <div class="row justify-content-center">
                <div class="col-12">
                  <h4 id="nombreListaGanadora" class="text-center mb-4"></h4>
                </div>
                <div class="col-md-6 text-center mb-4">
                  <h5>Presidente</h5>
                  <img id="fotoPresidente" src="" alt="Foto Presidente" class="img-fluid mb-2" style="max-width: 200px;">
                  <p id="nombrePresidente" class="font-weight-bold"></p>
                </div>
                <div class="col-md-6 text-center mb-4">
                  <h5>Vicepresidente</h5>
                  <img id="fotoVicepresidente" src="" alt="Foto Vicepresidente" class="img-fluid mb-2" style="max-width: 200px;">
                  <p id="nombreVicepresidente" class="font-weight-bold"></p>
                </div>
              </div>
            </div>
            
            <!-- Gráfica por Lista -->
            <div id="listaChartContainer" style="width: 400px; height: 300px; margin: auto; display: none;">
              <canvas id="listaChart"></canvas>
            </div>
            
            <!-- Gráfica por Departamento -->
            <div id="departamentoChartContainer" style="width: 400px; height: 300px; margin: auto; display: none;">
              <canvas id="departamentoChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container text-center">
      <p>Universidad de las Fuerzas Armadas "ESPE"</p>
      <p>Asociación de Docentes de las Fuerzas Armadas 2024</p>
    </div>
  </footer>

  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <div id="preloader"></div>

  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="../assets/js/main.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      const usuario = localStorage.getItem('usuario');
      const contrasenaHash = localStorage.getItem('contrasenaHash');

      // Verificar si hay usuario y contraseña
      if (usuario && contrasenaHash) {
        try {
          // Verificar si el usuario es administrador
          const response = await fetch(`/verificar-administrador?usuario=${usuario}&contrasenaHash=${contrasenaHash}`);
          const data = await response.json();

          if (!data.existe) {
            alert('No tiene permisos para acceder a esta página o su sesión ha expirado.');
            localStorage.clear();
            window.location.href = '/';
            return;
          }

          // Si el usuario es administrador válido, actualizar el display
          document.getElementById('username-display').innerHTML = `${usuario} <i class="bi bi-chevron-down toggle-dropdown"></i>`;
        } catch (error) {
          console.error('Error:', error);
          localStorage.clear();
          window.location.href = '/';
          return;
        }
      } else {
        window.location.href = '/';
        return;
      }

      // Manejar el cierre de sesión
      document.getElementById('logout-button').addEventListener('click', function() {
        localStorage.clear();
        window.location.href = '/';
      });

      fetch('/api/periodos')
        .then(response => response.json())
        .then(periodos => {
          const periodoSelect = document.getElementById('periodoSelect');
          periodos.forEach(periodo => {
            const option = document.createElement('option');
            option.value = periodo;
            option.textContent = periodo;
            periodoSelect.appendChild(option);
          });
        })
        .catch(err => console.error('Error al obtener los periodos:', err));

        document.getElementById('resultForm').addEventListener('submit', function(event) {
          event.preventDefault();
          
          const periodo = document.getElementById('periodoSelect').value;
          const filterType = document.getElementById('filterTypeSelect').value;
          const resultContainer = document.getElementById('resultContainer');
          const resultTable = document.getElementById('resultTable');
          const periodoHeader = document.getElementById('periodoHeader');
          const ganadoresContainer = document.getElementById('ganadoresContainer');
          
          const listaChartContainer = document.getElementById('listaChartContainer');
          const departamentoChartContainer = document.getElementById('departamentoChartContainer');

          if (periodo) {
            let apiUrl = filterType === 'lista' 
              ? `/api/resultados?periodo=${periodo}`
              : `/api/resultados/departamento?periodo=${periodo}`;
            
            fetch(apiUrl)
              .then(response => response.json())
              .then(data => {
                periodoHeader.textContent = `Resultados para el periodo ${periodo}`;
                
                if (filterType === 'lista') {
                  // Mostrar tabla de resultados
                  resultTable.innerHTML = generateResultsHtml(data.resultados);
                  
                  // Verificar si hay ganador único y no hay nulos mayoritarios
                  const listasNormales = data.resultados.filter(lista => !['NULO', 'BLANCO'].includes(lista.nombre.toUpperCase()));
                  const listaNulo = data.resultados.find(lista => lista.nombre.toUpperCase() === 'NULO');
                  const maxVotos = Math.max(...listasNormales.map(lista => lista.votos));
                  const listasGanadoras = listasNormales.filter(lista => lista.votos === maxVotos);
                  
                  // Solo mostrar ganador si hay un único ganador y los nulos no son mayoría
                  if (listasGanadoras.length === 1 && (!listaNulo || listaNulo.votos <= maxVotos)) {
                    if (data.ganadores) {
                      document.getElementById('nombreListaGanadora').textContent = `${data.ganadores.lista} - ${data.ganadores.porcentaje}% de los votos`;
                      
                      // Mostrar información de los candidatos
                      data.ganadores.candidatos.forEach(candidato => {
                        if (candidato.dignidad === 'presidente') {
                          document.getElementById('nombrePresidente').textContent = candidato.nombre;
                          document.getElementById('fotoPresidente').src = candidato.foto;
                        } else if (candidato.dignidad === 'vicepresidente') {
                          document.getElementById('nombreVicepresidente').textContent = candidato.nombre;
                          document.getElementById('fotoVicepresidente').src = candidato.foto;
                        }
                      });
                      
                      ganadoresContainer.style.display = 'block';
                    }
                  } else {
                    ganadoresContainer.style.display = 'none';
                  }
                  
                  listaChartContainer.style.display = 'block';
                  departamentoChartContainer.style.display = 'none';
                  createChart(data.resultados, 'lista');
                } else {
                  resultTable.innerHTML = generateResultsHtml(data, 'departamento');
                  ganadoresContainer.style.display = 'none';
                  listaChartContainer.style.display = 'none';
                  departamentoChartContainer.style.display = 'block';
                  createChart(data, 'departamento');
                }
                
                resultContainer.style.display = 'block';
              })
              .catch(err => console.error('Error al obtener los resultados:', err));
          }
        });

        function generateResultsHtml(data, filterType = 'lista') {
          let html = '<table class="table table-bordered table-striped table-hover">';
          
          if (filterType === 'lista') {
            const listasNormales = data.filter(lista => !['NULO', 'BLANCO'].includes(lista.nombre.toUpperCase()));
            const listaNulo = data.find(lista => lista.nombre.toUpperCase() === 'NULO');
            const listaBlanco = data.find(lista => lista.nombre.toUpperCase() === 'BLANCO');

            html += `
              <thead class="table-dark">
                <tr>
                  <th>Lista</th>
                  <th>Votos</th>
                  <th>Porcentaje</th>
                </tr>
              </thead>
              <tbody>`;

            listasNormales.forEach(lista => {
              html += `
                <tr>
                  <td>${lista.nombre}</td>
                  <td>${lista.votos}</td>
                  <td>${lista.porcentaje}%</td>
                </tr>`;
            });

            if (listaNulo) {
              html += `
                <tr>
                  <td>NULO</td>
                  <td>${listaNulo.votos}</td>
                  <td>${listaNulo.porcentaje}%</td>
                </tr>`;
            }
            if (listaBlanco) {
              html += `
                <tr>
                  <td>BLANCO</td>
                  <td>${listaBlanco.votos}</td>
                  <td>${listaBlanco.porcentaje}%</td>
                </tr>`;
            }
            
            html += '</tbody></table>';

            // Encontrar las listas con mayor número de votos
            if (listasNormales.length > 0) {
              const maxVotos = Math.max(...listasNormales.map(lista => lista.votos));
              const listasGanadoras = listasNormales.filter(lista => lista.votos === maxVotos);

              // Verificar si los votos nulos superan a la lista ganadora
              if (listaNulo && listaNulo.votos > maxVotos) {
                html += `<p style="color: red; text-align: center; font-weight: bold; font-size: 16px;">
                  ATENCIÓN: De acuerdo a los resultados obtenidos, se registra un total de ${listaNulo.votos} votos nulos (${listaNulo.porcentaje}%), 
                  superando a la lista con mayor votación ${listasGanadoras[0].nombre} que obtuvo ${maxVotos} votos (${listasGanadoras[0].porcentaje}%).<br><br>
                  En conformidad con el reglamento electoral de la Asociación de Docentes de las Fuerzas Armadas (ADUFA), 
                  se deberá convocar a un nuevo proceso electoral para la elección de la directiva.</p>`;
              } 
              // Verificar si hay empate
              else if (listasGanadoras.length > 1) {
                const listasPorcentaje = listasGanadoras[0].porcentaje;
                const nombresListas = listasGanadoras.map(lista => lista.nombre).join(' y ');
                html += `
                  <div style="margin: 20px 0;">
                    <p style="color: #dc3545; text-align: center; font-weight: bold; font-size: 16px; margin: 0;">
                      ATENCIÓN: Se ha registrado un empate técnico entre las listas ${nombresListas}, 
                      cada una con ${maxVotos} votos, representando un ${listasPorcentaje}% del total de votos emitidos.
                    </p>
                    <p style="color: #dc3545; text-align: center; font-weight: bold; font-size: 16px; margin-top: 15px;">
                      De acuerdo al reglamento electoral de la Asociación de Docentes de las Fuerzas Armadas (ADUFA), 
                      se deberá convocar a un nuevo proceso electoral para definir la directiva ganadora.
                    </p>
                  </div>`;
              }
            }
          } else {
            html += `
              <thead class="table-dark">
                <tr>
                  <th>Departamento</th>
                  <th>Votos</th>
                </tr>
              </thead>
              <tbody>`;

            data.forEach(departamento => {
              html += `
                <tr>
                  <td>${departamento.nombre}</td>
                  <td>${departamento.votos}</td>
                </tr>`;
            });
          }

          html += '</tbody></table>';
          return html;
        }

        function createChart(data, filterType) {
          let labels = [];
          let votosData = [];

          if (filterType === 'lista') {
              const listasNormales = data.filter(lista => lista.nombre.toLowerCase() !== 'nulo');
              const listaNulo = data.find(lista => lista.nombre.toLowerCase() === 'nulo');

              labels = listasNormales.map(lista => lista.nombre);
              votosData = listasNormales.map(lista => lista.votos);

              if (listaNulo) {
                  labels.push('NULO');
                  votosData.push(listaNulo.votos);
              }
          } else if (filterType === 'departamento') {
              labels = data.map(departamento => departamento.nombre);
              votosData = data.map(departamento => departamento.votos);
          }

          // Generar una lista de colores únicos para cada barra
          const colors = generateUniqueColors(votosData.length);

          const ctx = filterType === 'lista' ? document.getElementById('listaChart').getContext('2d') : document.getElementById('departamentoChart').getContext('2d');

          // Destruir la gráfica anterior si existe
          if (window.votosChart) {
              window.votosChart.destroy();
          }

          // Crear la nueva gráfica
          window.votosChart = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Número de Votos',
                      data: votosData,
                      backgroundColor: colors,
                      borderColor: colors,
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              stepSize: Math.ceil(Math.max(...votosData) / 10),
                              callback: function(value) {
                                  if (value >= 1000) {
                                      return value / 1000 + 'k'; 
                                  }
                                  return value;
                              }
                          },
                          max: Math.ceil(Math.max(...votosData) * 1.2)
                      }
                  },
                  plugins: {
                      legend: {
                          display: false
                      }
                  }
              }
          });
      }
    // Función para generar colores únicos
    function generateUniqueColors(numColors) {
        const colors = [];
        const step = 360 / numColors; // Espaciar los colores en el círculo cromático

        for (let i = 0; i < numColors; i++) {
            const hue = i * step;
            colors.push(`hsl(${hue}, 70%, 50%)`);
        }

        return colors;
    }
    });
  </script>
</body>
</html>
